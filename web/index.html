<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <meta name="viewport" content="width=375,user-scalable=no" />
        <script type="text/javascript" src="/eel.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/style.css">
        <link rel="stylesheet" href="./layui/css/layui.css">
    </head>
    <body>
        <div>
            <form class="layui-form" action="">
                <div class="header">
                    <div class="header_empty">
                    </div>
                    <div class="header_left">
                        <label class="layui-form-label" style="color: skyblue">选择串口:</label>
                        <div class="layui-input-block" style="width: 145px">
                            <select name="usart_name" id="usart_name" lay-verify="required" lay-filter="choose_port">
                            </select>
                        </div>
                    </div>
                    <div class="header_center">
                        <label class="layui-form-label" style="color: skyblue">波特率:</label>
                        <div class="layui-input-block" style="width: 145px">
                            <select name="baud_rate" lay-verify="required">
                                <option value="115200">115200</option>
                                <option value="1200">1200</option>
                                <option value="4800">4800</option>
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                            </select>
                        </div>
                    </div>
                    <div class="header_right">
                        <div class="layui-input-block">
                            <button id="open_usart_btn" class="layui-btn" lay-submit lay-filter="open_usart_btn">打开串口</button>
                        </div>
                    </div>
                </div>
            </form>

            <div class="container">
                <div class="menu">
                    <div class="a layui-side layui-bg-black">
                        <div class="layui-side-scroll">
                            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                            <ul id="param_item_list"class="layui-nav layui-nav-tree" lay-filter="test" >
                                <!-- 侧边导航: <ul class="layui-nav layui-nav-tree layui-nav-side"> -->
                                <!-- 从component_config.json配置文件中动态生成bbb"> -->
                                <li class="bbb layui-nav-item layui-nav-itemed">
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
                <div class="input_echo">
                    <div class="paramInput">
                        <form class="layui-form" action="">
                            <div class="paramInput_inner">
                                <div class="paramInput_a" style="display: flex; flex: 6;">
                                    <div class="label" style="display: flex; flex: 1;"><label id="send_param_label" name="send_param_label" class="layui-form-label" style="width: auto; margin: 0 auto;">默认:</label></div>
                                    <div class="gg" style="flex: 4;">
                                        <input type="text" name="send_param_key" id="send_param_key" args_separator="," key_value_separator="=>" placeholder="请输入参数,回车执行(若该命令不需要参数，请直接点击执行即可)" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="paramInput_b">
                                    <div class="qq">
                                        <button id="send_data_btn" class="layui-btn" lay-submit lay-filter="send_data_btn">执行</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="resultEcho" style="display: flex; flex-direction: column">
                        <div class="res_container" style="height: 100%">
                            <textarea id="res_echo" name="usart_echo" placeholder="结果回显区暂无内容" class="layui-textarea" style="height: 100%"></textarea>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </body>

    <script src="./layui/layui.js"></script>
    <script>
        let $;
        //一般直接写在一个js文件中
        layui.use(['layer', 'form', 'element'], function(){
            var layer = layui.layer
                ,form = layui.form;
            var element = layui.element;
            $ = layui.jquery;
            //监听send_data发送数据给串口的提交
            form.on('submit(send_data_btn)', function(data){
                //取出input_container cmd args_separator key_value_separator 
                var input_container=$("#send_param_key").val();
                var cmd_name = $("#send_param_key").attr("name");
                var args_separator = $("#send_param_key").attr("args_separator");
                var key_value_separator = $("#send_param_key").attr("key_value_separator");
                //保存构造好的将要发送的串口数据
                var str ="";
                //如果input标签是"默认:",即cmd_name是默认的send_param_key
                if (cmd_name == "send_param_key") {
                    str = input_container;
                }
                //如果input_container没有填入任何参数
                else if (input_container == "") {
                    str = "\r\n{cmd" +key_value_separator+'"'+ cmd_name +'"' + "}\r\n"
                }
                //如果参数只有一个,即不存在args_separator,如:cmd=>"set_server_ip",ip=>"127.0.0.1"(注意:在不存在args_separator时，set_server_ip的ip必须以_开始，因为ip=>"127.0.0.1"的ip是通过cmd_name的最后一个_字段来确定的),在input只要输入127.0.0.1
                //input_container不包含args_separator
                else if (input_container.indexOf(args_separator) == -1) {
                //则构造字符串的方法为:
                    var cmd_name_xx = cmd_name.substring(cmd_name.lastIndexOf("_")+1, cmd_name.length);//提取cmd_name的后_字段
                    str = "\r\n{cmd" + key_value_separator +'"'+ cmd_name +'"'+ args_separator + cmd_name_xx + key_value_separator +'"'+ input_container +'"'+ "}\r\n"
                } 
                //如果参数大于2个，即存在args_separator，如:\r\n{cmd=>"led_act",led0=>"on"}\r\n,在input中输入为led0,on
                //则构造字符串的方法为: 
                //input_container包含args_separator
                else if (input_container.indexOf(args_separator) != -1) {
                //则构造字符串的方法为:
                    var before = input_container.substring(0, input_container.indexOf(args_separator));//提取args_separator前面的led0
                    var after = input_container.substring(input_container.indexOf(args_separator)+1, input_container.length);//提取args_separator后面的on
                    str = "\r\n{cmd" + key_value_separator +'"'+ cmd_name +'"'+ args_separator + before + key_value_separator +'"'+ after +'"'+ "}\r\n"
                } 
                layer.msg(str);

                js_send_data(str);
                return false;
            });

            //监听打开串口的提交
            form.on('submit(open_usart_btn)', function(data){
                js_open_port(JSON.stringify(data.field));
                return false;
            });

            js_get_all_port();

            //动态监听菜单项点击事件 button是未来动态加入的按钮
            $('#param_item_list').on('click', "button", function() {
                console.log('click!')
                var value = $(this).text()
                //取出cmd args_separator key_value_separator
                var cmd_name = $(this).attr("id");
                var args_separator = $(this).attr("args_separator");
                var key_value_separator = $(this).attr("key_value_separator");
                console.log(cmd_name)
                console.log("args_separator被点击",args_separator)
                console.log("key_value_separator被点击", key_value_separator)
                //把cmd args_separator key_value_separator设置到串口参数输入区的input输入框的相应属性中去
                $("#send_param_key").attr("name", cmd_name);
                $("#send_param_label").text(value);
                $("#send_param_key").attr("args_separator", args_separator);
                $("#send_param_key").attr("key_value_separator", key_value_separator);
            })

            //关闭菜单项鼠标右键默认事件
            $('#param_item_list').on('contextmenu', "button", function(e) {
                return false;
            });
            //动态监听菜单项的鼠标右击事件
            $('#param_item_list').on('mousedown', "button", function(e) {
                if (1 == e.which) {
                    console.log("你点了左键");
                } else if (2 == e.which) {
                    console.log("你点了滚轮");
                } else if (3 == e.which) {
                    console.log("你点了右键");
                }
            })
            
            //监听input参数输入区的"默认:"二字是否被点击,被点击则转为串口助手模式(即发什么就是什么)
            $('#send_param_label').on('click', function() {
                $("#send_param_key").attr("name", "send_param_key");
                $("#send_param_label").text("默认:");
            })
            
            js_get_component_config();
        });

        //获取所有串口 
        // 调用python中的函数
        async function js_get_all_port(){
            // 调用python中的函数,注意需要在定义前加上async声明异步    
            let content = await eel.py_get_all_port()();  //这里用let不用var,调用的python函数后面是两对括号
            console.log(content)
            for (var i = 0; i < content.length; i++) {
                $('#usart_name').append(new Option(content[i], content[i]));
                //$('#usart_name').append(new Option(content[i], i));
            }
            layui.form.render("select");
        }


        //打开串口
        // 调用python中的函数
        async function js_open_port(res){  
            var label = $("#open_usart_btn").html();
            if (label == "打开串口") {
                console.log("111")
                var label = $("#open_usart_btn").text("关闭串口");
                //把res传递给python
                await eel.py_open_port(res)();

                //调用python中的函数
                //let res_from_py = await eel.py_receive_data()();
                //console.log(res_from_py)


            } else if (label == "关闭串口") {
                console.log("222")
                var label = $("#open_usart_btn").text("打开串口");
                await eel.py_close_port()();
            }
            //var label =$("#usart_name option:selected").html();//jquery获取被html标签包围的文本内容
            //var res=$("#usart_name option:selected").val();//jquery获取html标签内的内容
        }

        // 将js中的函数暴露给python
        eel.expose(js_fun);
        function js_fun(res_from_py){
            console.log(typeof(res_from_py));
            console.log('js_fun从py得到的内容：' + res_from_py);
            var source = $("#res_echo").val();
            source = source + res_from_py;
            console.log(source)
            $("#res_echo").val(source);
            //$("#res_echo").text(source);
        }

        // 调用python中的函数
        async function js_send_data(data){  
            //把传递给python
            await eel.py_send_data(data)();
        }
        
        // 调用python中的函数
        // 获取菜单功能控件的配置(即component_config.json文件的内容) 
        async function js_get_component_config(){  
            let component_obj= await eel.py_read_component_config()();
            console.log(component_obj)
            console.log(typeof(component_obj))

            //解析配置文件
            var component_obj_html="";
            for (var key1 in component_obj) {
                if (key1.charAt(key1.length-1) == ":")
                    //console.log("a----------------------", key1)
                    component_obj_html += `<li class="layui-nav-item layui-nav-item"><a href="javascript:;">`+key1+`</a><dl class="layui-nav-child">`
                else
                    console.log("aaaaaaaaaaaaaaaaaa")
                console.log("level1的功能控件数量为:", Object.keys(component_obj).length)//获取对象长度
                console.log("level1的功能控件名为:", key1)
                let obj = component_obj[key1];
                console.log("111", obj[Object.keys(obj)[0]])
                if (typeof(obj[Object.keys(obj)[0]]) == "object") {
                    console.log("level1的下面还有下一层,下一层为:", obj)
                    console.log("level2的功能控件数量为:", Object.keys(obj).length)//获取对象长度
                    let obj2;
                    for (var key2 in obj) {
                        if (key2.charAt(key2.length-1) == ":")
                            //console.log("b----------------------", key2)
                            component_obj_html += `<li class="layui-nav-item layui-nav-item"><a href="javascript:;">`+key2+`</a><dl class="layui-nav-child">`
                        else
                            console.log("bbbbbbbbbbbbbbbbbb")
                        console.log("level2的功能控件名为:", key2)
                        obj2 = obj[key2];
                        console.log("222", obj2[Object.keys(obj2)[0]])
                        if (typeof(obj2[Object.keys(obj2)[0]]) == "object") {
                            console.log("level2的下面还有下一层,下一层为:", obj2)
                            console.log("level3的功能控件数量为:", Object.keys(obj2).length)//获取对象长度
                            let obj3;
                            for (var key3 in obj2) {
                                if (key3.charAt(key3.length-1) == ":")
                                    //console.log("c----------------------", key3)
                                    component_obj_html += `<li class="layui-nav-item layui-nav-item"><a href="javascript:;">`+key3+`</a><dl class="layui-nav-child">`
                                else
                                    console.log("cccccccccc")
                                console.log("level3的功能控件名为:", key3)
                                obj3 = obj2[key3];
                                console.log("3333", obj3[Object.keys(obj3)[0]])
                                if (typeof(obj3[Object.keys(obj3)[0]]) == "object") {
                                    console.log("level3的下面还有下一层,下一层为:", obj3)
                                    console.log("level4的功能控件数量为:", Object.keys(obj3).length)//获取对象长度
                                    let obj4;
                                    for (var key4 in obj3) {
                                        if (key4.charAt(key4.length-1) == ":")
                                            //console.log("d----------------------", key4)
                                            component_obj_html += `<li class="layui-nav-item layui-nav-item"><a href="javascript:;">`+key4+`</a><dl class="layui-nav-child">`
                                        else
                                            console.log("ddddddddddd")
                                        console.log("level4的功能控件名为:", key4)
                                        obj4 = obj3[key4];
                                        console.log("4444", obj4[Object.keys(obj4)[0]])
                                        if (typeof(obj4[Object.keys(obj4)[0]]) == "object") {
                                            console.log("level4的下面还有下一层,下一层为:", obj4)
                                        } 
                                        if (key4.charAt(key4.length-1) == ":")
                                            //console.log("d----------------------endxxxxxxx", key4)
                                            component_obj_html += `</dl></li>`
                                        else
                                            //console.log("ddddddddddd----ending")
                                            component_obj_html += `<dd><button id="` +obj4[Object.keys(obj4)[0]]+ `"` + `args_separator="` +obj4[Object.keys(obj4)[2]]+ `"` + `key_value_separator="` +obj4[Object.keys(obj4)[1]]+ `"` +  `class="layui-btn" lay-submit style="background:#141519">`+key4+`</button></dd>`
                                    }
                                } 
                                if (key3.charAt(key3.length-1) == ":") 
                                    //console.log("c----------------------endxxxxxxxxxxx", key3)
                                    component_obj_html += `</dl></li>`
                                else
                                    //console.log("cccccccccc-----ending")
                                    component_obj_html += `<dd><button id="` +obj3[Object.keys(obj3)[0]]+ `"` + `args_separator="` +obj3[Object.keys(obj3)[2]]+ `"` + `key_value_separator="` +obj3[Object.keys(obj3)[1]]+ `"` +  `class="layui-btn" lay-submit style="background:#1c1e24">`+key3+`</button></dd>`
                            }
                        }
                        if (key2.charAt(key2.length-1) == ":")
                            //console.log("b----------------------", key2)
                            component_obj_html += `</dl></li>`
                        else
                            //console.log("bbbbbbbbbbbbbbbbbb----ending")
                            component_obj_html += `<dd><button id="` +obj2[Object.keys(obj2)[0]]+ `"` + `args_separator="` +obj2[Object.keys(obj2)[2]]+ `"` + `key_value_separator="` +obj2[Object.keys(obj2)[1]]+ `"` +  `class="layui-btn" lay-submit style="background:#1c1e24">`+key2+`</button></dd>`
                    }
                }
                if (key1.charAt(key1.length-1) == ":")
                    //console.log("a----------------------", key1)
                    component_obj_html += `</dl></li>`
                else
                    //console.log("aaaaaaaaaaaaaaaaaa___endimg")
                    component_obj_html += `<dd><button id="` +obj1[Object.keys(obj1)[0]]+ `"` + `args_separator="` +obj1[Object.keys(obj1)[2]]+ `"` + `key_value_separator="` +obj1[Object.keys(obj1)[1]]+ `"` +  `class="layui-btn" lay-submit style="background:#1c1e24">`+key1+`</button></dd>`
            }
            $(".bbb").append(component_obj_html);
            //更新layui,不然动态生成的layui_html标签不起作用
            layui.element.init();
        }


    </script> 
</html>
